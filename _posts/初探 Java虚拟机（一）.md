---
title: Java内存区域（一）程序计数器与虚拟机栈
date: 2021-11-29 22:06:51
tags:
- Java
- Jvm
categories:
- [Java,Jvm]
---

Java 虚拟机在执行Java程序的时候会把他所管理的内存区域划分成若干个不同的数据区域。这些区域有各自的用途及创建和销毁的时间，有的区域随着虚拟机进程的启动而一直存在。有的区域则是依赖用户线程的启动和结束而建立和销毁。

![](https://cdn.jsdelivr.net/gh/Xiaomy749/metocs_pic/202111292221629.jpg)

​																												*图 1-1 java虚拟机运行时数据区*

### 一、运行时数据区域

#### 1.程序计数器

程序计数器是一块较小的内存空间，可看作为当前线程执行的字节码的行号指示器。字节码通过该计数器的值选取下一条要执行的字节码命令。分支、循环、跳转、异常处理、线程恢复等都需要依赖此计数器完成。

各条线程之间计数器互不影响，独立存储。这类内存区域称为“线程私有”的内存

如果线程正在执行一个Java方法，这个计数器记录的是正在执行的虚拟机字节码指令的地址；如果是本地（Native）方法，则计数器对应值为空（Undefined）

此区域是唯一在《Java虚拟机规范》中没有规定任何 `OutOfMemoryError` 情况的区域

#### 2.Java 虚拟机栈

与程序计数器一样，Java虚拟机栈也是线程私有的。它的生命周期和线程的生命周期相同。Java虚拟机栈是描述Java方法执行的线程模型。每个方法被执行的时候，Java虚拟机栈都会同步创建一个栈帧，每个方法被调用直至执行完毕的过程就对应着一个栈帧在虚拟机栈中从入栈到出战的过程。

栈中存储内容：

- 局部变量表

- 操作数栈

- 动态连接

- 方法出口等

  

局部表量表：

1. 局部变量表存放了编译器可知的各种Java虚拟机基本数据类型（`boolean`，`byte`，`char`，`short`，`int`，`float`，`long`，`double`）
2. 对象引用（`reference`类型，它并不是对象本身，可能是一个指向对象起始地址的引用指针，也可能时指向代表对象的句柄或其他与此对象相关的位置）
3. `returnAddress`类型（指向了一条字节码指令的地址）

这些数据类型在局部变量表的存储空间中以局部变量槽（Slot）表示，其中64位长度的`long`与`double`数据会占用两个变量槽，其余占用一个。

局部变量表所需的内存空间是在编译期完成分配的，当进入一个方法时，这个方法所需分配的空间大小是完全确定的。（注意这里的大小指的时变量槽的数量的多少）

**栈** 通常情况下指虚拟机栈，或更多情况下只是指虚拟机栈中局部变量表的部分。

此区域的两种异常情况

- `StackOverflowError`异常： 线程请求的栈深度大于虚拟机所允许的深度。（例如 错误的递归操作）
- `OutOfMemoryError`异常：如果Java虚拟机的栈容量可以动态扩展，当栈扩展时无法申请到足够的内存的时候会抛出。（大部分虚拟机的栈容量时不可以动态扩展的，但是线程申请空间失败仍会抛出OOM异常）

